import{S as L,i as P,s as j,k as h,q as O,a as w,l as p,m as v,r as A,h as l,c as y,n as U,b as g,G as k,O as C,H as S,X as E,o as R}from"../chunks/index.5b37bd6f.js";import{g as N}from"../chunks/navigation.732952cc.js";import{S as m}from"../chunks/sweetalert2.all.fe32f612.js";function D(s){let o,a,r,t,n,u,d,i,f,b,x;return{c(){o=h("button"),a=O("Register Passwordless Authenticator"),r=w(),t=h("br"),n=w(),u=h("br"),d=w(),i=h("button"),f=O("Log Out"),this.h()},l(e){o=p(e,"BUTTON",{class:!0});var c=v(o);a=A(c,"Register Passwordless Authenticator"),c.forEach(l),r=y(e),t=p(e,"BR",{}),n=y(e),u=p(e,"BR",{}),d=y(e),i=p(e,"BUTTON",{class:!0});var I=v(i);f=A(I,"Log Out"),I.forEach(l),this.h()},h(){U(o,"class","mb-4 rounded bg-blue-500 px-4 py-2 font-bold text-white hover:bg-blue-700"),U(i,"class","mb-4 rounded bg-red-500 px-4 py-2 font-bold text-white hover:bg-red-700")},m(e,c){g(e,o,c),k(o,a),g(e,r,c),g(e,t,c),g(e,n,c),g(e,u,c),g(e,d,c),g(e,i,c),k(i,f),b||(x=[C(o,"click",s[1]),C(i,"click",s[0])],b=!0)},p:S,i:S,o:S,d(e){e&&l(o),e&&l(r),e&&l(t),e&&l(n),e&&l(u),e&&l(d),e&&l(i),b=!1,E(x)}}}function T(s){const o=new Uint8Array(s);return btoa(String.fromCharCode.apply(null,o)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function J(s){const o=s.replace(/-/g,"+").replace(/_/g,"/"),a=atob(o),r=a.length,t=new Uint8Array(r);for(let n=0;n<r;n++)t[n]=a.charCodeAt(n);return t.buffer}function B(s){const o=(s+"=".repeat((4-s.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),a=atob(o),r=new Uint8Array(a.length);for(let t=0;t<a.length;++t)r[t]=a.charCodeAt(t);return r}function Y(s){return R(()=>{localStorage.getItem("sessionToken")||(m.fire({icon:"error",title:"Not logged in!",text:"You're not logged in! Log in to access your settings."}),N("/"))}),[function(){localStorage.removeItem("uuid"),localStorage.removeItem("sessionToken"),document.getElementById("login-btn").innerHTML="Login",document.getElementById("login-btn").href="/login",m.fire({icon:"success",title:"Logged out!",text:"You've been logged out. You can now log in again."}),N("/")},async function(){let o=localStorage.getItem("uuid");try{const a=localStorage.getItem("sessionToken"),r=await fetch("https://crowdcards-api.glitch.me/webauthn/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userUUID:o,stoken:a})}),t=await r.json();t.challenge=B(t.challenge),t.user.id=B(t.user.id),t.excludeCredentials=t.excludeCredentials.map(i=>({...i,id:J(i.id)}));const n=await navigator.credentials.create({publicKey:t}),u={rawId:T(n.rawId),id:n.id,type:n.type,response:{clientDataJSON:T(n.response.clientDataJSON),attestationObject:T(n.response.attestationObject)}},d=await fetch("https://crowdcards-api.glitch.me/webauthn/register/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userUUID:o,attestationResponse:u})});localStorage.setItem("sessionToken",await d.text()),m.fire({icon:"success",title:"Added!",text:'The authenticator was sucessfully added! You can now log in using the "Use Passwordless Auth" button on the login page.'})}catch(a){console.error("Error during registration:",a),m.fire({icon:"error",title:"Whoops...",text:"Something went wrong adding the authenticator. This could have many causes- you might have timed out or the API is down. Try again!"})}}]}class G extends L{constructor(o){super(),P(this,o,Y,D,j,{})}}export{G as component};
