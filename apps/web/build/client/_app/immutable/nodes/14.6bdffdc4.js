import{S as j,i as R,s as D,k as f,q as x,a as w,l as b,m as S,r as O,h as c,c as y,n as A,b as d,G as I,O as k,H as U,X as J,o as _}from"../chunks/index.5b37bd6f.js";import{g as Y}from"../chunks/navigation.abb71fe0.js";import{S as u}from"../chunks/sweetalert2.all.fe32f612.js";function q(a){let e,i,s,o,n,h,p,l,T,m,g,v,N,E;return{c(){e=f("button"),i=x("Register Passwordless Authenticator"),s=w(),o=f("br"),n=w(),h=f("br"),p=w(),l=f("button"),T=x("Log Out"),m=w(),g=f("button"),v=x("Enable Notifications"),this.h()},l(t){e=b(t,"BUTTON",{class:!0});var r=S(e);i=O(r,"Register Passwordless Authenticator"),r.forEach(c),s=y(t),o=b(t,"BR",{}),n=y(t),h=b(t,"BR",{}),p=y(t),l=b(t,"BUTTON",{class:!0});var B=S(l);T=O(B,"Log Out"),B.forEach(c),m=y(t),g=b(t,"BUTTON",{class:!0});var P=S(g);v=O(P,"Enable Notifications"),P.forEach(c),this.h()},h(){A(e,"class","mb-4 rounded bg-blue-500 px-4 py-2 font-bold text-white hover:bg-blue-700"),A(l,"class","mb-4 rounded bg-red-500 px-4 py-2 font-bold text-white hover:bg-red-700"),A(g,"class","hover:bg-red-green mb-4 rounded bg-green-500 px-4 py-2 font-bold text-white")},m(t,r){d(t,e,r),I(e,i),d(t,s,r),d(t,o,r),d(t,n,r),d(t,h,r),d(t,p,r),d(t,l,r),I(l,T),d(t,m,r),d(t,g,r),I(g,v),N||(E=[k(e,"click",a[2]),k(l,"click",a[1]),k(g,"click",a[0])],N=!0)},p:U,i:U,o:U,d(t){t&&c(e),t&&c(s),t&&c(o),t&&c(n),t&&c(h),t&&c(p),t&&c(l),t&&c(m),t&&c(g),N=!1,J(E)}}}function C(a){const e=new Uint8Array(a);return btoa(String.fromCharCode.apply(null,e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function G(a){const e=a.replace(/-/g,"+").replace(/_/g,"/"),i=atob(e),s=i.length,o=new Uint8Array(s);for(let n=0;n<s;n++)o[n]=i.charCodeAt(n);return o.buffer}function L(a){const e=(a+"=".repeat((4-a.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),i=atob(e),s=new Uint8Array(i.length);for(let o=0;o<i.length;++o)s[o]=i.charCodeAt(o);return s}function H(a){return _(()=>{localStorage.getItem("sessionToken")||(u.fire({icon:"error",title:"Not logged in!",text:"You're not logged in! Log in to access your settings."}),Y("/"))}),[function(){"Notification"in window?Notification.permission==="granted"?u.fire({icon:"alert",title:"Already enabled!",text:"You already gave us notification permissions. No need to give them to us again!"}):Notification.permission!=="denied"&&Notification.requestPermission().then(e=>{e==="granted"&&(new Notification("Thanks!",{body:"You've enabled notifications for CrowdCards! We'll send you notifications when stuff happens (Namely, your cards have a status change).",icon:"https://cdn.glitch.com/560ed5ed-9d00-433a-9ff9-7750d79d13da%2FGlitch_TeamAvatar.png?v=1624643105812"}),u.fire({icon:"success",title:"Enabled!",text:"Notifications enabled! You should see one right now. :)"}))}):u.fire({icon:"error",title:"Not supported!",text:"Apologies, but this browser doesn't support notifications yet."})},function(){localStorage.removeItem("uuid"),localStorage.removeItem("sessionToken"),document.getElementById("login-btn").innerHTML="Login",document.getElementById("login-btn").href="/login",u.fire({icon:"success",title:"Logged out!",text:"You've been logged out. You can now log in again."}),Y("/")},async function(){let e=localStorage.getItem("uuid");try{const i=localStorage.getItem("sessionToken"),s=await fetch("https://crowdcards-api.glitch.me/webauthn/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userUUID:e,stoken:i})}),o=await s.json();o.challenge=L(o.challenge),o.user.id=L(o.user.id),o.excludeCredentials=o.excludeCredentials.map(l=>({...l,id:G(l.id)}));const n=await navigator.credentials.create({publicKey:o}),h={rawId:C(n.rawId),id:n.id,type:n.type,response:{clientDataJSON:C(n.response.clientDataJSON),attestationObject:C(n.response.attestationObject)}},p=await fetch("https://crowdcards-api.glitch.me/webauthn/register/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userUUID:e,attestationResponse:h})});localStorage.setItem("sessionToken",await p.text()),u.fire({icon:"success",title:"Added!",text:'The authenticator was sucessfully added! You can now log in using the "Use Passwordless Auth" button on the login page.'})}catch(i){console.error("Error during registration:",i),u.fire({icon:"error",title:"Whoops...",text:"Something went wrong adding the authenticator. This could have many causes- you might have timed out or the API is down. Try again!"})}}]}class M extends j{constructor(e){super(),R(this,e,H,q,D,{})}}export{M as component};
