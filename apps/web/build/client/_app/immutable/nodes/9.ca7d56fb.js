import{S as $e,i as Fe,s as Ye,a as g,k as n,q as N,K as qe,h as l,c as m,l as o,m as U,r as P,n as a,b as B,G as t,O as Ge,H as Me,o as ze,N as Qe}from"../chunks/index.5b37bd6f.js";import{g as q}from"../chunks/navigation.abb71fe0.js";import{S as x}from"../chunks/sweetalert2.all.fe32f612.js";const{document:Ue}=Qe;function Ve(E){let S,v,b,I,w,C,c,i,f,r,u,h,y,D,j,O,L,Y,_,M,te,ne,oe,H,ae,G,z,Q,V,K,re,X,Z,ee,s,$,se,ie,le,J,de,ce,ue,he,R,pe,ge,me,fe,F,we,ye,be,A,Te,Be,xe,W,Ie,Se,ve,Ee,Ce,Oe,Ne;return Ue.title=S=E[0],{c(){v=g(),b=n("h2"),I=N("Create a new user"),w=g(),C=n("br"),c=g(),i=n("form"),f=n("label"),r=N("Username:"),u=n("br"),h=g(),y=n("input"),D=n("br"),j=g(),O=n("label"),L=N("Password:"),Y=n("br"),_=g(),M=n("input"),te=n("br"),ne=n("br"),oe=g(),H=n("button"),ae=N("Create User"),G=g(),z=n("br"),Q=n("br"),V=g(),K=n("h2"),re=N("Login"),X=g(),Z=n("br"),ee=g(),s=n("form"),$=n("label"),se=N("Username:"),ie=n("br"),le=g(),J=n("input"),de=n("br"),ce=g(),ue=n("br"),he=g(),R=n("button"),pe=N("Use Passwordless Auth"),ge=g(),me=n("br"),fe=g(),F=n("label"),we=N("Password:"),ye=n("br"),be=g(),A=n("input"),Te=n("br"),Be=n("br"),xe=g(),W=n("button"),Ie=N("Login"),Se=g(),ve=n("br"),Ee=g(),Ce=n("br"),this.h()},l(e){qe("svelte-1258swp",Ue.head).forEach(l),v=m(e),b=o(e,"H2",{class:!0});var p=U(b);I=P(p,"Create a new user"),p.forEach(l),w=m(e),C=o(e,"BR",{}),c=m(e),i=o(e,"FORM",{id:!0});var T=U(i);f=o(T,"LABEL",{for:!0});var Pe=U(f);r=P(Pe,"Username:"),Pe.forEach(l),u=o(T,"BR",{}),h=m(T),y=o(T,"INPUT",{class:!0,type:!0,id:!0,name:!0}),D=o(T,"BR",{}),j=m(T),O=o(T,"LABEL",{for:!0});var De=U(O);L=P(De,"Password:"),De.forEach(l),Y=o(T,"BR",{}),_=m(T),M=o(T,"INPUT",{class:!0,type:!0,id:!0,name:!0}),te=o(T,"BR",{}),ne=o(T,"BR",{}),oe=m(T),H=o(T,"BUTTON",{type:!0,class:!0});var Le=U(H);ae=P(Le,"Create User"),Le.forEach(l),T.forEach(l),G=m(e),z=o(e,"BR",{}),Q=o(e,"BR",{}),V=m(e),K=o(e,"H2",{class:!0});var Je=U(K);re=P(Je,"Login"),Je.forEach(l),X=m(e),Z=o(e,"BR",{}),ee=m(e),s=o(e,"FORM",{id:!0});var d=U(s);$=o(d,"LABEL",{for:!0});var Re=U($);se=P(Re,"Username:"),Re.forEach(l),ie=o(d,"BR",{}),le=m(d),J=o(d,"INPUT",{class:!0,type:!0,id:!0,name:!0,autocomplete:!0}),de=o(d,"BR",{}),ce=m(d),ue=o(d,"BR",{}),he=m(d),R=o(d,"BUTTON",{type:!0,class:!0});var Ae=U(R);pe=P(Ae,"Use Passwordless Auth"),Ae.forEach(l),ge=m(d),me=o(d,"BR",{}),fe=m(d),F=o(d,"LABEL",{for:!0});var ke=U(F);we=P(ke,"Password:"),ke.forEach(l),ye=o(d,"BR",{}),be=m(d),A=o(d,"INPUT",{class:!0,type:!0,id:!0,name:!0,autocomplete:!0}),Te=o(d,"BR",{}),Be=o(d,"BR",{}),xe=m(d),W=o(d,"BUTTON",{type:!0,class:!0});var je=U(W);Ie=P(je,"Login"),je.forEach(l),Se=m(d),ve=o(d,"BR",{}),Ee=m(d),Ce=o(d,"BR",{}),d.forEach(l),this.h()},h(){a(b,"class","text-3xl"),a(f,"for","create-username"),a(y,"class","rounded-sm text-black"),a(y,"type","text"),a(y,"id","create-username"),a(y,"name","create-username"),a(O,"for","create-password"),a(M,"class","rounded-sm text-black"),a(M,"type","password"),a(M,"id","create-password"),a(M,"name","create-password"),a(H,"type","submit"),a(H,"class","mb-2 mr-2 rounded-lg bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-gradient-to-br focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800"),a(i,"id","create-user-form"),a(K,"class","text-3xl"),a($,"for","login-username"),a(J,"class","rounded-sm text-black"),a(J,"type","text"),a(J,"id","login-username"),a(J,"name","login-username"),a(J,"autocomplete","username webauthn"),a(R,"type","button"),a(R,"class","mb-2 mr-2 rounded-lg bg-gradient-to-r from-green-400 via-green-500 to-green-600 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-gradient-to-br focus:outline-none focus:ring-4 focus:ring-green-300 dark:focus:ring-green-800"),a(F,"for","login-password"),a(A,"class","rounded-sm text-black"),a(A,"type","password"),a(A,"id","login-password"),a(A,"name","login-password"),a(A,"autocomplete","password webauthn"),a(W,"type","submit"),a(W,"class","mb-2 mr-2 rounded-lg bg-gradient-to-r from-red-400 via-red-500 to-red-600 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-gradient-to-br focus:outline-none focus:ring-4 focus:ring-red-300 dark:focus:ring-red-800"),a(s,"id","login-form")},m(e,p){B(e,v,p),B(e,b,p),t(b,I),B(e,w,p),B(e,C,p),B(e,c,p),B(e,i,p),t(i,f),t(f,r),t(i,u),t(i,h),t(i,y),t(i,D),t(i,j),t(i,O),t(O,L),t(i,Y),t(i,_),t(i,M),t(i,te),t(i,ne),t(i,oe),t(i,H),t(H,ae),B(e,G,p),B(e,z,p),B(e,Q,p),B(e,V,p),B(e,K,p),t(K,re),B(e,X,p),B(e,Z,p),B(e,ee,p),B(e,s,p),t(s,$),t($,se),t(s,ie),t(s,le),t(s,J),t(s,de),t(s,ce),t(s,ue),t(s,he),t(s,R),t(R,pe),t(s,ge),t(s,me),t(s,fe),t(s,F),t(F,we),t(s,ye),t(s,be),t(s,A),t(s,Te),t(s,Be),t(s,xe),t(s,W),t(W,Ie),t(s,Se),t(s,ve),t(s,Ee),t(s,Ce),Oe||(Ne=Ge(R,"click",E[1]),Oe=!0)},p(e,[p]){1&p&&S!==(S=e[0])&&(Ue.title=S)},i:Me,o:Me,d(e){e&&l(v),e&&l(b),e&&l(w),e&&l(C),e&&l(c),e&&l(i),e&&l(G),e&&l(z),e&&l(Q),e&&l(V),e&&l(K),e&&l(X),e&&l(Z),e&&l(ee),e&&l(s),Oe=!1,Ne()}}}const He="https://crowdcards-api.glitch.me/webauthn/authenticate",Ke="https://crowdcards-api.glitch.me/webauthn/authenticate/verify";function k(E){const S=new Uint8Array(E);return btoa(String.fromCharCode.apply(null,S)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function We(E){const S=E.replace(/-/g,"+").replace(/_/g,"/"),v=atob(S),b=v.length,I=new Uint8Array(b);for(let w=0;w<b;w++)I[w]=v.charCodeAt(w);return I.buffer}function _e(E){const S=(E+"=".repeat((4-E.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),v=atob(S),b=new Uint8Array(v.length);for(let I=0;I<v.length;++I)b[I]=v.charCodeAt(I);return b}function Xe(E,S,v){let b;const I=new AbortController;return ze(async()=>{document.getElementById("create-user-form").addEventListener("submit",c=>{c.preventDefault();const i=document.getElementById("create-username").value,f=document.getElementById("create-password").value;fetch("https://crowdcards-api.glitch.me/api/addUser",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:i,password:f})}).then(r=>r.text()).then(r=>{r.startsWith("002")?x.fire({icon:"warning",title:"Error!",text:`Something went wrong. The error returned was ${r}.`,confirmButtonText:"Darn it"}):x.fire({icon:"success",title:"Success!",text:`Your account was created! It's UUID is ${r}.`,confirmButtonText:"Awesome!",showDenyButton:!0,denyButtonText:"Log into new account"}).then(u=>{u.isDenied&&(r?fetch("https://crowdcards-api.glitch.me/api/startSession",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({UUID:r,password:f,logintype:1})}).then(h=>{if(h.status===400)x.fire({icon:"warning",title:"Error!",text:"Invalid username or password. This shouldn't have happened, please contact the developers.",confirmButtonText:":("});else{if(h.status!==403)return h.text();x.fire({icon:"error",title:"Banned!",text:"This account has been banned from CrowdCards. This should NOT have happened, contact the developers to get your account unbanned.",confirmButtonText:"Aw, man!"})}}).then(h=>{h?(localStorage.setItem("uuid",r),localStorage.setItem("sessionToken",h),document.getElementById("login-btn").innerHTML="Profile",document.getElementById("login-btn").href="/profile",q("/")):x.fire({icon:"warning",title:"Error!",text:"Invalid username or password. This shouldn't have happened, please contact the developers.",confirmButtonText:":("})}):x.fire({icon:"warning",title:"Error!",text:"Invalid username or password. This shouldn't have happened, please contact the developers.",confirmButtonText:":("}))})})}),document.getElementById("login-form").addEventListener("submit",c=>{c.preventDefault();const i=document.getElementById("login-username").value,f=document.getElementById("login-password").value;fetch("https://crowdcards-api.glitch.me/api/getUUID",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:i,usertype:1})}).then(r=>r.text()).then(r=>{r?fetch("https://crowdcards-api.glitch.me/api/startSession",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({UUID:r,password:f,logintype:1})}).then(u=>{if(u.status===400)x.fire({icon:"warning",title:"Error!",text:"Invalid username or password.",confirmButtonText:"Whoops"});else{if(u.status!==403)return u.text();x.fire({icon:"error",title:"Banned!",text:"This account has been banned from CrowdCards. See the TOS for more information.",showCancelButton:!0,confirmButtonText:"Aw, man!",cancelButtonText:"Open TOS"}).then(h=>{h.isDenied&&(window.location.href="https://cdn.glitch.global/d24a8d52-d1f8-43e5-a4b9-2b8939c0a945/CrowdCards%20TOS%20planning.pdf?v=1675547587832")})}}).then(u=>{u?(localStorage.setItem("uuid",r),localStorage.setItem("sessionToken",u),document.getElementById("login-btn").innerHTML="Profile",document.getElementById("login-btn").href="/profile",q("/")):x.fire({icon:"warning",title:"Error!",text:"Invalid username or password.",confirmButtonText:"Whoops"})}):x.fire({icon:"error",title:"Error!",text:"Invalid username or password.",confirmButtonText:"Whoops"})})});const w=localStorage.getItem("uuid"),C=localStorage.getItem("sessionToken");if(w&&C&&fetch("https://crowdcards-api.glitch.me/api/checkSession",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({UUID:w,stoken:C})}).then(c=>c.text()).then(c=>{c==="001"?(document.getElementById("login-btn").innerHTML="Profile",document.getElementById("login-btn").href="/profile",q("/")):(localStorage.removeItem("uuid"),localStorage.removeItem("sessionToken"))}),window.PublicKeyCredential&&PublicKeyCredential.isConditionalMediationAvailable){console.log("hi");const c=await PublicKeyCredential.isConditionalMediationAvailable();if(console.log(c),c){console.log("pain");let i=!1;try{let f=await fetch("https://crowdcards-api.glitch.me/api/getUUID",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:document.getElementById("login-username").value,usertype:1})}),r=await f.text();const u=await fetch(He,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userUUID:r})}),h=await u.json();h.challenge=_e(h.challenge),h.allowCredentials=h.allowCredentials.map(_=>({..._,id:We(_.id)}));const y=await navigator.credentials.get({publicKey:h,mediation:"conditional",signal:I.signal}),D={rawId:k(y.rawId),id:y.id,type:y.type,response:{authenticatorData:k(y.response.authenticatorData)+"=",signature:k(y.response.signature)+"=",clientDataJSON:k(y.response.clientDataJSON)}};i=!0;const j=await fetch(Ke,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userUUID:r,attestationResponse:D})}),O=await j.json(),L=O.res.session,Y=O.res.uuid;localStorage.setItem("sessionToken",L),localStorage.setItem("uuid",Y),document.getElementById("login-btn").innerHTML="Profile",document.getElementById("login-btn").href="/profile",q("/")}catch(f){i===!0&&(console.error("Error during authentication:",f),x.fire({icon:"error",title:"Whoops...",text:"Something went wrong while authenticating. This could have many causes- you might have timed out, the API is down, or you didn't add a passwordless auth method. Try again!"}))}}}}),v(0,b="CrowdCards - Login"),["CrowdCards - Login",async function(){let w=!1;I.abort();try{let C=await fetch("https://crowdcards-api.glitch.me/api/getUUID",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:document.getElementById("login-username").value,usertype:1})}),c=await C.text();if(console.log(c),c===""&&(await x.fire({icon:"warning",title:"No/Invalid username!",text:"You haven't inputted a username, or the one you inputted is invalid. Logging in passwordless will work fine, but it's reccomended to input one anyway in case of issues. Continue?",confirmButtonText:"Continue",showDenyButton:!0,denyButtonText:"Exit"})).isDenied)throw w=!0,"User denied authentication";const i=await fetch(He,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userUUID:c})}),f=await i.text();console.log(f);const r=JSON.parse(f);if(console.log(JSON.stringify(r.allowCredentials)===JSON.stringify([])),r.challenge=_e(r.challenge),JSON.stringify(r.allowCredentials)===JSON.stringify([])&&c!=="")throw await x.fire({icon:"error",title:"Passwordless not supported!",text:"This user has not registered a passwordless authentication method. If this is you, head over to Settings to add one once you're logged in."}),w=!0,"Atempted to auth as non-passwordless user";if(JSON.stringify(r.allowCredentials)===JSON.stringify([])&&c==="")throw await x.fire({icon:"error",title:"Nobody is passwordless!",text:"Nobody has registered a passwordless authentication method. If this is you, head over to Settings to add one once you're logged in."}),w=!0,"Nobody is passwordless :skull:";r.allowCredentials=r.allowCredentials.map(L=>({...L,id:We(L.id)}));const u=await navigator.credentials.get({publicKey:r});console.log(u);const h={rawId:k(u.rawId),id:u.id,type:u.type,response:{authenticatorData:k(u.response.authenticatorData)+"=",signature:k(u.response.signature)+"=",clientDataJSON:k(u.response.clientDataJSON)}},y=await fetch(Ke,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userUUID:c,attestationResponse:h})}),D=await y.json(),j=D.res.session,O=D.res.uuid;localStorage.setItem("sessionToken",j),localStorage.setItem("uuid",O),document.getElementById("login-btn").innerHTML="Profile",document.getElementById("login-btn").href="/profile",q("/")}catch(C){console.error("Error during authentication:",C),w===!1&&x.fire({icon:"error",title:"Whoops...",text:"Something went wrong while authenticating. This could have many causes- you might have timed out, the API is down, or you didn't add a passwordless auth method. Try again!"})}}]}class nt extends $e{constructor(S){super(),Fe(this,S,Xe,Ve,Ye,{})}}export{nt as component};
